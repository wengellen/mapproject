function isObservableArray(obj){return ko.isObservable(obj)&&obj.hasOwnProperty("remove")}var initialLocations=["San Francisco","Taipei","Thailand","Brazil"],Location=function(data){this.name=ko.observable(data)},map,markers=[],nav=document.querySelector(".nav");ko.bindingHandlers.map={init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){function CenterControl(controlDiv,map){var controlUI=document.createElement("div");controlUI.classList.add("map-button"),controlUI.title="Click to show controls",controlDiv.appendChild(controlUI);var controlText=document.createElement("div");controlText.classList.add("map-button-text"),controlUI.appendChild(controlText),controlText.innerHTML="Center Map",controlUI.addEventListener("click",function(){var center=map.getCenter();console.log(center),google.maps.event.trigger(map,"resize"),map.setCenter(center)})}var locationList=ko.unwrap(valueAccessor()),minZoomLevel=0,mapOptions={zoom:minZoomLevel,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(element,mapOptions);var centerControlDiv=document.createElement("div");new CenterControl(centerControlDiv,map);centerControlDiv.index=1,map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);new google.maps.places.PlacesService(map);window.mapBounds=new google.maps.LatLngBounds,bindingContext.$data.addMarkers(locationList)},update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){ko.unwrap(valueAccessor());bindingContext.$data.filterMarkers()}};var ViewModel=function(){function matchQuery(marker){var filter=self.searchString().toLowerCase();return ko.utils.stringStartsWith(marker.name.toLowerCase(),filter)}function callback(result,status){status===google.maps.places.PlacesServiceStatus.OK&&self.addMarker(result[0])}var self=this;this.newLocation=ko.observable(""),this.searchString=ko.observable(""),this.locationList=ko.observableArray(ko.utils.arrayMap(initialLocations,function(locationItem){return new Location(locationItem)})),this.currentLocation=ko.observable(new Location({name:""})),this.toggleNav=function(item,event){console.log("toggleNav"),nav.classList.toggle("visible"),event.stopPropagation()},this.setCurrentLocation=function(data){self.currentLocation(data)},this.closeControls=function(){map.hideControls()},this.validPlace=ko.computed(function(){return""!==self.newLocation()}),this.addLocation=function(){function addToList(locObject){self.locationList.push(locObject),self.filterLocations()}function addThisMarker(locObj){var request,service=new google.maps.places.PlacesService(map);request={query:locObj.name()},service.textSearch(request,callback)}if(self.validPlace()){self.clearSearch();var place=self.newLocation(),match=ko.utils.arrayFirst(self.locationList(),function(item){return place===item.name()});if(!match){var locObject=new Location(place);self.setCurrentLocation(locObject),addToList(locObject),addThisMarker(locObject)}self.newLocation("")}},this.clearSearch=function(){self.searchString("")},this.filterLocations=ko.computed(function(){var filter=self.searchString().toLowerCase();return filter?(arr=ko.utils.arrayFilter(self.locationList(),function(item){return ko.utils.stringStartsWith(item.name().toLowerCase(),filter)}),arr):self.locationList()}),this.filterMarkers=function(){for(var i=(new google.maps.places.PlacesService(map),0);i<markers.length;i++){var marker=markers[i];matchQuery(marker)?self.showMarker(marker):self.hideMarker(marker)}},this.selectThisPlace=function(place){for(var i=0;i<markers.length;i++){var marker=markers[i];self.deactivateMarker(marker),place()===marker.name&&(self.activateMarker(marker),console.log("match found: "+marker.name))}},this.activateMarker=function(marker){marker.setIcon("http://maps.google.com/mapfiles/ms/icons/green-dot.png"),marker.isSelected=!0,self.setInfoWindow(marker),marker.infoWindow.open(map,marker),marker.toggleBounce(),self.selectItem(marker,!0)},this.deactivateMarker=function(marker){marker.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png"),marker.isSelected=!1,marker.infoWindow.close(),marker.toggleBounce(),self.selectItem(marker,!1)},this.showMarker=function(marker){for(var i=0;i<markers.length;i++)markers[i]===marker&&(markers[i].setMap(map),self.deactivateMarker(marker))},this.hideMarker=function(marker){for(var i=0;i<markers.length;i++)markers[i]===marker&&markers[i].setMap(null)},this.addMarkers=function(locObjList){var request,service=new google.maps.places.PlacesService(map);locObjList.forEach(function(place){request={query:place.name()},service.textSearch(request,callback)})},this.setInfoWindow=function(marker){var wikiHtmlString,wikiUrl="http://en.wikipedia.org/w/api.php?action=opensearch&search="+marker.name+"&format=json&callback=wikiCallback",wikiRequestTimeout=setTimeout(function(){wikiHtmlString="Failed to get wikipedia resources",marker.infoWindow.setContent(wikiHtmlString)},8e3);$.ajax({url:wikiUrl,dataType:"jsonp",success:function(response){var title=response[1][0],body=response[2][0],url="http://en.wikipedia.org/wiki/"+title;wikiHtmlString='<a href="'+url+'">'+title+"</a><div>"+body+"</div>";var contentString='<div id="content" ><div id="siteNotice"></div><h1 id="firstHeading" class="firstHeading">'+marker.name+'</h1><div id="bodyContent"><a href="'+url+'" target="_blank">Read More...</a><div style="color:#777">'+body+"</div></div></div>";clearTimeout(wikiRequestTimeout),marker.infoWindow.setContent(contentString)}})},this.selectItem=function(marker,isTrue){for(var $items=(self.filterLocations(),document.getElementsByClassName("list-item")),i=0;i<$items.length;i++)$items[i].textContent===marker.name&&(isTrue?$items[i].classList.add("active"):$items[i].classList.remove("active"))},this.addMarker=function(place){var lat=place.geometry.location.lat(),lon=place.geometry.location.lng(),formattedAddress=place.formatted_address,bounds=window.mapBounds,activeIcon="http://maps.google.com/mapfiles/ms/icons/green-dot.png",inactiveIcon="http://maps.google.com/mapfiles/ms/icons/red-dot.png",marker=new google.maps.Marker({map:map,icon:inactiveIcon,animation:google.maps.Animation.DROP,position:place.geometry.location,title:formattedAddress,name:place.name});marker.infoWindow=new google.maps.InfoWindow({content:"<i class='loading' title='Loading...'></i> Loading...",maxWidth:200}),marker.toggleBounce=function(){var self=this;self.isSelected?self.setAnimation(google.maps.Animation.BOUNCE):self.setAnimation(null)},place.name===self.currentLocation().name()&&self.activateMarker(marker),markers.push(marker),google.maps.event.addListener(marker,"click",function(){self.activateMarker(marker)}),google.maps.event.addListener(marker.infoWindow,"closeclick",function(){self.deactivateMarker(marker)}),google.maps.event.addListener(marker,"mouseover",function(){marker.setIcon(activeIcon)}),google.maps.event.addListener(marker,"mouseout",function(){marker.isSelected||marker.setIcon(inactiveIcon)}),google.maps.event.addDomListener(window,"resize",function(){console.log("resize");var center=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(center)}),bounds.extend(new google.maps.LatLng(lat,lon)),map.fitBounds(bounds)}};$(document).ready(function(){ko.applyBindings(new ViewModel)}),ko.utils.stringStartsWith=function(string,startsWith){return string=string||"",startsWith.length>string.length?!1:string.substring(0,startsWith.length)===startsWith};