function isObservableArray(obj){return ko.isObservable(obj)&&obj.hasOwnProperty("remove")}var initialLocations=["San Francisco","Taipei","London","Johannesburg","Mumbai"],Location=function(data){this.name=ko.observable(data)},map,markers=[],nav=document.querySelector(".nav"),menu_icon=document.querySelector(".menu_icon");"undefined"!=typeof ko&&ko.bindingHandlers&&!ko.bindingHandlers.multiselect&&(ko.bindingHandlers.map={init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){function CenterControl(controlDiv,map){var controlUI=document.createElement("div");controlUI.classList.add("map-button"),controlUI.title="Click to show controls",controlDiv.appendChild(controlUI);var controlText=document.createElement("div");controlText.classList.add("map-button-text"),controlUI.appendChild(controlText),controlText.innerHTML="Center",controlUI.addEventListener("click",function(){bindingContext.$data.fitMap(),bindingContext.$data.deactivateMarker(bindingContext.$data.currentMarker())})}var locationList=bindingContext.$data.filterLocations(),minZoomLevel=0,mapOptions={zoom:minZoomLevel,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(element,mapOptions);var centerControlDiv=document.createElement("div");new CenterControl(centerControlDiv,map);centerControlDiv.index=1,map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);new google.maps.places.PlacesService(map);window.mapBounds=new google.maps.LatLngBounds,bindingContext.$data.addMarkers(locationList)},update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){bindingContext.$data.filterLocations()}});var ViewModel=function(){function matchQuery(marker){var filter=self.searchString().toLowerCase();return ko.utils.stringStartsWith(marker.name.toLowerCase(),filter)}function callback(result,status){status===google.maps.places.PlacesServiceStatus.OK&&self.addMarker(result[0])}var self=this;this.newLocation=ko.observable(""),this.searchString=ko.observable(""),this.currentMarker=ko.observable({}),this.locationList=ko.observableArray(ko.utils.arrayMap(initialLocations,function(locationItem){return new Location(locationItem)})),this.currentLocation=ko.observable(new Location({name:""})),this.toggleNav=function(item,event){console.log("toggleNav"),nav.classList.toggle("visible"),event.stopPropagation(),console.log(menu_icon),menu_icon.classList.contains("contract")?(menu_icon.classList.remove("contract"),menu_icon.classList.add("expand")):(menu_icon.classList.remove("expand"),menu_icon.classList.add("contract"))},this.setCurrentLocation=function(data){self.currentLocation(data)},this.closeControls=function(){nav.classList.remove("visible"),menu_icon.classList.remove("expand"),menu_icon.classList.add("contract")},this.initAutoComplete=function(){console.log("initAutoComplete"),$("#add-input").autocomplete({source:function(request,response){console.log(request),$.ajax({url:"http://gd.geobytes.com/AutoCompleteCity",dataType:"jsonp",data:{q:request.term},success:function(data){response(data)}})},minLength:3,select:function(event,ui){cityString=ui.item.label,cityArr=cityString.split(","),self.newLocation(cityArr[0]),self.addLocation(cityArr[0])},open:function(){$(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){$(this).removeClass("ui-corner-top").addClass("ui-corner-all")}})}(self),this.validPlace=ko.computed(function(){return""!==self.newLocation()}),this.addLocation=function(){function addToList(locObject){self.locationList.push(locObject),self.filterLocations()}function addThisMarker(locObj){var request,service=new google.maps.places.PlacesService(map);request={query:locObj.name()},service.textSearch(request,callback)}if(self.validPlace()){self.clearSearch();var place=self.newLocation(),match=ko.utils.arrayFirst(self.locationList(),function(item){return place===item.name()});if(!match){var locObject=new Location(place);self.setCurrentLocation(locObject),addToList(locObject),addThisMarker(locObject);var latLng=self.currentMarker().getPosition();map.setCenter(latLng),map.setZoom(4),self.offsetMap()}self.newLocation(""),self.closeControls()}},this.clearSearch=function(){self.searchString("")},this.filterLocations=ko.computed(function(){var filter=self.searchString().toLowerCase();return filter?(arr=ko.utils.arrayFilter(self.locationList(),function(item){return ko.utils.stringStartsWith(item.name().toLowerCase(),filter)}),arr):self.locationList()}),this.filterMarkers=function(){for(var i=(new google.maps.places.PlacesService(map),0);i<markers.length;i++){var marker=markers[i];matchQuery(marker)?self.showMarker(marker):self.hideMarker(marker)}},this.selectThisPlace=function(place){for(var i=0;i<markers.length;i++){var marker=markers[i];self.deactivateMarker(marker),place()===marker.name&&(self.activateMarker(marker),console.log("match found: "+marker.name))}self.closeControls()},this.selectThisMarker=function(marker){for(var i=0;i<markers.length;i++)markerItem=markers[i],self.deactivateMarker(markerItem),markerItem===marker&&(self.activateMarker(marker),console.log("match found: "+marker.name));self.closeControls()},this.offsetMap=function(){map.panBy(0,-80)},this.activateMarker=function(marker){self.currentMarker(marker),marker.setIcon("http://maps.google.com/mapfiles/ms/icons/green-dot.png"),marker.isSelected=!0,self.setInfoWindow(marker),marker.infoWindow.open(map,marker),marker.toggleBounce();var latLng=marker.getPosition();map.setCenter(latLng),map.setZoom(4),self.offsetMap(),self.selectItem(marker,!0)},this.deactivateMarker=function(marker){marker.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png"),marker.isSelected=!1,marker.infoWindow.close(),marker.toggleBounce(),self.selectItem(marker,!1)},this.showMarker=function(marker){for(var i=0;i<markers.length;i++)markers[i]===marker&&(markers[i].setMap(map),self.deactivateMarker(marker))},this.hideMarker=function(marker){for(var i=0;i<markers.length;i++)markers[i]===marker&&markers[i].setMap(null)},this.addMarkers=function(locObjList){var request,service=new google.maps.places.PlacesService(map);locObjList.forEach(function(place){request={query:place.name()},service.textSearch(request,callback)})},this.setInfoWindow=function(marker){var wikiHtmlString,baseUrl="http://en.wikipedia.org/",wikiUrl=baseUrl+"/w/api.php?action=opensearch&search="+marker.name+"&format=json&callback=wikiCallback",wikiRequestTimeout=setTimeout(function(){wikiHtmlString="Failed to get wikipedia resources",marker.infoWindow.setContent(wikiHtmlString)},8e3);$.ajax({url:wikiUrl,dataType:"jsonp",async:!0}).done(function(response){console.log("success");var title=response[1][0],body=response[2][0],url=baseUrl+"/wiki/"+title;wikiHtmlString='<a href="'+url+'">'+title+"</a><div>"+body+"</div>";var nameArr=marker.title.split(","),city=nameArr[0],country=nameArr[nameArr.length-1],contentString='<div id="content" ><div id="siteNotice"></div><h1 id="firstHeading" class="firstHeading">'+city+'<span id="secondHeading" class="secondHeading">'+country+'</span></h1><div id="bodyContent"><a href="'+url+'" target="_blank">Read More...</a><div style="color:#777">'+body+"</div></div></div>";clearTimeout(wikiRequestTimeout),marker.infoWindow.setContent(contentString)})},this.selectItem=function(marker,isTrue){for(var $items=(self.filterLocations(),document.getElementsByClassName("list-item")),i=0;i<$items.length;i++)$items[i].textContent===marker.name&&(isTrue?$items[i].classList.add("active"):$items[i].classList.remove("active"))},this.fitMap=function(){var bounds=new google.maps.LatLngBounds;for(i=0;i<markers.length;i++)bounds.extend(markers[i].getPosition());map.fitBounds(bounds)},this.addMarker=function(place){var lat=place.geometry.location.lat(),lon=place.geometry.location.lng(),formattedAddress=place.formatted_address,bounds=window.mapBounds,activeIcon="http://maps.google.com/mapfiles/ms/icons/green-dot.png",inactiveIcon="http://maps.google.com/mapfiles/ms/icons/red-dot.png",marker=new google.maps.Marker({map:map,icon:inactiveIcon,animation:google.maps.Animation.DROP,position:place.geometry.location,title:formattedAddress,name:place.name});marker.infoWindow=new google.maps.InfoWindow({content:"<i class='loading' title='Loading...'></i> Loading...",maxWidth:200}),marker.toggleBounce=function(){var self=this;self.isSelected?self.setAnimation(google.maps.Animation.BOUNCE):self.setAnimation(null)},place.name===self.currentLocation().name()&&self.activateMarker(marker),markers.push(marker),self.currentMarker(marker),google.maps.event.addListener(marker,"click",function(){self.selectThisMarker(marker)}),google.maps.event.addListener(marker.infoWindow,"closeclick",function(){self.deactivateMarker(marker),self.fitMap()}),google.maps.event.addListener(marker,"mouseover",function(){marker.setIcon(activeIcon)}),google.maps.event.addListener(marker,"mouseout",function(){marker.isSelected||marker.setIcon(inactiveIcon)}),google.maps.event.addDomListener(window,"resize",function(){console.log("resize"),self.fitMap()}),bounds.extend(new google.maps.LatLng(lat,lon)),map.fitBounds(bounds)}};ko.utils.stringStartsWith=function(string,startsWith){return string=string||"",startsWith.length>string.length?!1:string.substring(0,startsWith.length)===startsWith};